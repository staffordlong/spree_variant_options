<div id="product-variants">
  <h6 id="variant-not-available" class="variant-not-available hidden">This variant is not available right now.</h6>
  <ul class="list-group">
    <% option_value_ids = @product.variants.joins(:option_values).pluck("spree_option_values.id").uniq %>
    <% ordered_option_types = @product.ordered_option_types.includes(:option_values) %>

    <% ordered_option_types.each_with_index do |type, index| %>
      <div id="<%= dom_id(type) %>" class="variant-options index-<%= index %>">
        <h6 class="variant-option-type">Available <%= type.presentation.pluralize %><%= (option_type_heading_suffixes ||= {})[type.name.parameterize.to_sym] %></h6>
        <% if (selector_types ||= {})[type.name.parameterize.to_sym] == 'dropdown' %>
          <select class="dropdown">
            <% type.option_values.sort_by(&:position).each do |value| %>
              <% if option_value_ids.include? value.id %>
                <%= content_tag(:option, value.presentation, { class: "option-value", data: { type_id: type.id, value_id: value.id, level: (index + 1) } }) %>
              <% end %>
            <% end %>
          </select>
        <% else %>
          <ul class="variant-option-values<%= " variant-option-values--#{type.name.parameterize}" %>">
            <% type.option_values.sort_by(&:position).each do |value| %>
              <% if option_value_ids.include? value.id %>
                <li class="variant-option-values__value<%= " variant-option-values__value--#{type.name.parameterize}" %>">
                  <%= link_to value.has_image? ? image_tag(value.image.url, alt: value.presentation) : content_tag(:span, value.presentation), "#", title: value.presentation, class: "option-value", data: { type_id: type.id, value_id: value.id, level: (index + 1) } %>
                </li>
              <% end %>
            <% end %>
            <li class="clear-option hidden">
              <%= link_to "X", "#clear", class: "clear-button", data: { level: index } %>
            </li>
            <li class="clear"></li>
          </ul>
        <% end %>
        <% if (post_selector_content ||= {}).try(type.name.parameterize.to_sym) %>
          <%= post_selector_content[type.presentation.parameterize.to_sym] %>
        <% end %>
      </div>
    <% end %>
    <%= hidden_field_tag "variant_id", "", id: "variant_id", class: "hidden" %>
    <script type="text/javascript">
    //<![CDATA[
      var variant_option_details = <%== @product.variants_option_value_details.to_json %>
      var options = {
        option_type_count: <%== ordered_option_types.length %>,
        allow_select_outofstock: <%== !!SpreeVariantOptions::VariantConfig[:allow_select_outofstock] %>,
        default_instock: <%== !!SpreeVariantOptions::VariantConfig[:default_instock] %>
      }

    //]]>
    </script>
  </ul>
</div>

<%= javascript_include_tag 'frontend/variant_options' %>


